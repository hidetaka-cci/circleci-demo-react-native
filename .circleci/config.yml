version: 2.1

orbs:
  node: circleci/node@7.2.1
  android: circleci/android@3.2.0

jobs:
  android-run-tests:
    executor:
      name: android/android_machine
      tag: "2024.01.1"
      resource_class: large
    steps:
      - checkout
      - run:
          name: Debug - Check project structure
          command: |
            echo "=== Hypothesis A: Check if android directory exists after checkout ==="
            pwd
            ls -la
            if [ -d "android" ]; then
              echo "CONFIRMED: android directory exists"
              ls -la android/ | head -10
            else
              echo "REJECTED: android directory does NOT exist after checkout"
            fi
            echo "=== Hypothesis B: Check if android is in .gitignore ==="
            if grep -q "^/android$" .gitignore 2>/dev/null || grep -q "^android$" .gitignore 2>/dev/null; then
              echo "CONFIRMED: android is in .gitignore"
              grep -E "^/?android" .gitignore || echo "Pattern found in .gitignore"
            else
              echo "REJECTED: android not found in .gitignore"
            fi
            echo "=== Hypothesis C: Check if node_modules exists ==="
            if [ -d "node_modules" ]; then
              echo "CONFIRMED: node_modules exists"
            else
              echo "REJECTED: node_modules does NOT exist (npm install needed)"
            fi
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Run Android tests
          command: |
            echo "=== Hypothesis E: Attempt cd android ==="
            if [ -d "android" ]; then
              echo "CONFIRMED: android directory exists, proceeding with tests"
              cd android && ./gradlew test
            else
              echo "REJECTED: android directory still does not exist"
              echo "Attempting to generate android directory with expo prebuild..."
              npm install
              npx expo prebuild --platform android
              if [ -d "android" ]; then
                echo "CONFIRMED: android directory created successfully"
                cd android && ./gradlew test
              else
                echo "REJECTED: Failed to create android directory"
                exit 1
              fi
            fi
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
  android-build:
    executor:
      name: android/android_machine
      tag: "2024.01.1"
      resource_class: large
    steps:
      - checkout
      - run:
          name: Debug - Check project structure
          command: |
            echo "=== Hypothesis A: Check if android directory exists after checkout ==="
            pwd
            ls -la
            if [ -d "android" ]; then
              echo "CONFIRMED: android directory exists"
              ls -la android/ | head -10
            else
              echo "REJECTED: android directory does NOT exist after checkout"
            fi
            echo "=== Hypothesis B: Check if android is in .gitignore ==="
            if grep -q "^/android$" .gitignore 2>/dev/null || grep -q "^android$" .gitignore 2>/dev/null; then
              echo "CONFIRMED: android is in .gitignore"
              grep -E "^/?android" .gitignore || echo "Pattern found in .gitignore"
            else
              echo "REJECTED: android not found in .gitignore"
            fi
            echo "=== Hypothesis C: Check if node_modules exists ==="
            if [ -d "node_modules" ]; then
              echo "CONFIRMED: node_modules exists"
            else
              echo "REJECTED: node_modules does NOT exist (npm install needed)"
            fi
            echo "=== Hypothesis D: Check if package.json exists ==="
            if [ -f "package.json" ]; then
              echo "CONFIRMED: package.json exists"
              cat package.json | grep -A 5 '"scripts"'
            else
              echo "REJECTED: package.json does NOT exist"
            fi
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Build Android Debug APK
          command: |
            echo "=== Hypothesis E: Attempt cd android ==="
            if [ -d "android" ]; then
              echo "CONFIRMED: android directory exists, proceeding with build"
              cd android && ./gradlew assembleDebug
            else
              echo "REJECTED: android directory still does not exist"
              echo "Attempting to generate android directory with expo prebuild..."
              npm install
              npx expo prebuild --platform android
              if [ -d "android" ]; then
                echo "CONFIRMED: android directory created successfully"
                cd android && ./gradlew assembleDebug
              else
                echo "REJECTED: Failed to create android directory"
                exit 1
              fi
            fi
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

workflows:
  ci:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              ignore: main
      - android-run-tests:
          filters:
            branches:
              ignore: main

  deploy:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              only: main
      - android-build:
          requires:
            - node/test
          filters:
            branches:
              only: main
