version: 2.1

orbs:
  node: circleci/node@7.2.1
  android: circleci/android@3.2.0

jobs:
  android-run-tests:
    executor:
      name: android/android_machine
      tag: "2024.01.1"
      resource_class: large
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate android directory
          command: npx expo prebuild --platform android
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Run Android tests
          command: cd android && ./gradlew test
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
  android-build:
    executor:
      name: android/android_docker
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate android directory
          command: npx expo prebuild --platform android
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Build Android Debug APK
          command: cd android && ./gradlew assembleDebug
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
  android-build-macos:
    macos:
      xcode: "26.2.0"
    steps:
      - checkout
      - node/install:
          node-version: "24.0.0"
      - run:
          name: Install Java 21
          command: |
            brew install openjdk@21
            echo 'export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"' >> ~/.zshrc
            export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
            java -version
      - run:
          name: Install Android SDK
          command: |
            export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
            export ANDROID_HOME=$HOME/Library/Android/sdk
            mkdir -p $ANDROID_HOME/cmdline-tools
            if [ ! -d "$ANDROID_HOME/cmdline-tools/latest" ]; then
              cd $ANDROID_HOME/cmdline-tools
              curl -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-mac-11076708_latest.zip
              unzip -q cmdline-tools.zip
              mv cmdline-tools latest
              rm cmdline-tools.zip
            fi
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
            sdkmanager --version
      - run:
          name: Install Android SDK components
          command: |
            export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
            export ANDROID_HOME=$HOME/Library/Android/sdk
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
            # 既存のライセンスを受け入れる
            yes | sdkmanager --licenses || true
            # 各パッケージをライセンス承認付きでインストール
            echo y | sdkmanager "platform-tools"
            echo y | sdkmanager "platforms;android-34"
            echo y | sdkmanager "platforms;android-36"
            echo y | sdkmanager "build-tools;34.0.0"
            echo y | sdkmanager "build-tools;35.0.0"
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate android directory
          command: |
            export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
            export ANDROID_HOME=$HOME/Library/Android/sdk
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
            npx expo prebuild --platform android
      - restore_cache:
          keys:
            - gradle-v1-macos-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-macos-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-macos-
      - run:
          name: Build Android Debug APK
          command: |
            export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
            export ANDROID_HOME=$HOME/Library/Android/sdk
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
            cd android
            ./gradlew assembleDebug
      - save_cache:
          key: gradle-v1-macos-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

workflows:
  ci:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              ignore: main
      - android-run-tests:
          filters:
            branches:
              ignore: main

  deploy:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              only:
                - main
                - experiment/macos-build
      - android-build:
          requires:
            - node/test
          filters:
            branches:
              only:
                - main
      - android-build-macos:
          requires:
            - node/test
          filters:
            branches:
              only:
                - main
                - experiment/macos-build