version: 2.1

orbs:
  node: circleci/node@7.2.1
  android: circleci/android@3.2.0

jobs:
  android-run-tests:
    executor:
      name: android/android_machine
      tag: "2024.01.1"
      resource_class: large
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate android directory
          command: npx expo prebuild --platform android
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Run Android tests
          command: cd android && ./gradlew test
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
  android-build:
    executor:
      name: android/android_machine
      tag: "2024.01.1"
      resource_class: xlarge
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate android directory
          command: npx expo prebuild --platform android
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
            - gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-v1-
      - run:
          name: Build Android Debug APK
          command: cd android && ./gradlew assembleDebug
      - save_cache:
          key: gradle-v1-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

  ios-build:
    macos:
      xcode: "15.4.0"
    resource_class: macos.m1.medium
    steps:
      - checkout
      - node/install:
          node-version: "20.18.1"
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Generate ios directory
          command: npx expo prebuild --platform ios
      - restore_cache:
          keys:
            - cocoapods-v1-{{ checksum "ios/Podfile.lock" }}
            - cocoapods-v1-
      - run:
          name: Install CocoaPods (if missing)
          command: |
            if command -v pod >/dev/null 2>&1; then
              pod --version
            else
              sudo gem install cocoapods
            fi
      - run:
          name: Install Pods
          command: cd ios && pod install
      - run:
          name: Build iOS (Debug, Simulator)
          command: |
            WORKSPACE=$(ls -1 ios/*.xcworkspace | head -n 1)
            SCHEME=$(xcodebuild -list -json -workspace "$WORKSPACE" | python3 -c 'import json,sys; print(json.load(sys.stdin)["workspace"]["schemes"][0])')
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination 'generic/platform=iOS Simulator' \
              build
      - save_cache:
          key: cocoapods-v1-{{ checksum "ios/Podfile.lock" }}
          paths:
            - ios/Pods
            - ios/Podfile.lock
            - ~/.cocoapods
            - ~/Library/Caches/CocoaPods

workflows:
  ci:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              ignore: main
      - android-run-tests:
          filters:
            branches:
              ignore: main

  deploy:
    jobs:
      - node/test:
          pkg-manager: npm
          executor:
            name: node/default
            tag: 'current'
          cache-version: v1
          filters:
            branches:
              only: main
      - android-build:
          requires:
            - node/test
          filters:
            branches:
              only: main

      - ios-build:
          requires:
            - node/test
          filters:
            branches:
              only: main
